Quest_WaBao = {}
Quest_WaBao[1]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10001}
Quest_WaBao[2]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10002}
Quest_WaBao[3]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10003}
Quest_WaBao[4]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10004}
Quest_WaBao[5]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10005}
Quest_WaBao[6]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10006}
Quest_WaBao[7]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10007}
Quest_WaBao[8]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10008}
Quest_WaBao[9]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10009}
Quest_WaBao[10]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10010}
Quest_WaBao[11]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10011}
Quest_WaBao[12]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10012}
Quest_WaBao[13]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10013}
Quest_WaBao[14]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10014}
Quest_WaBao[15]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10015}
Quest_WaBao[16]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10016}
Quest_WaBao[17]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10017}
Quest_WaBao[18]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10018}
Quest_WaBao[19]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10019}
Quest_WaBao[20]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10020}
Quest_WaBao[21]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10021}
Quest_WaBao[22]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10022}
Quest_WaBao[23]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10023}
Quest_WaBao[24]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10024}
Quest_WaBao[25]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10025}
Quest_WaBao[26]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10026}
Quest_WaBao[27]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10027}
Quest_WaBao[28]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10028}
Quest_WaBao[29]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10029}
Quest_WaBao[30]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10030}
Quest_WaBao[31]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10031}
Quest_WaBao[32]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10032}
Quest_WaBao[33]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10033}
Quest_WaBao[34]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10034}
Quest_WaBao[35]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10035}
Quest_WaBao[36]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10036}
Quest_WaBao[37]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10037}
Quest_WaBao[38]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10038}
Quest_WaBao[39]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10039}
Quest_WaBao[40]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10040}
Quest_WaBao[41]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10041}
Quest_WaBao[42]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10042}
Quest_WaBao[43]={TargetType=QuestTargetType["Collect"], TargetID1=1351001, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10043}
Quest_WaBao[44]={TargetType=QuestTargetType["Collect"], TargetID1=1351002, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10044}
Quest_WaBao[45]={TargetType=QuestTargetType["Collect"], TargetID1=1351003, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10045}
Quest_WaBao[46]={TargetType=QuestTargetType["Collect"], TargetID1=1351004, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10046}
Quest_WaBao[47]={TargetType=QuestTargetType["Collect"], TargetID1=1351005, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10047}
Quest_WaBao[48]={TargetType=QuestTargetType["Collect"], TargetID1=1351006, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10048}
Quest_WaBao[49]={TargetType=QuestTargetType["Collect"], TargetID1=1351007, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=10049}


Quest_WaBao_Pos = {}
Quest_WaBao_Pos[1] = {x=2074, z=1661}
Quest_WaBao_Pos[2] = {x=2013, z=2039}
Quest_WaBao_Pos[3] = {x=2330, z=1845}
Quest_WaBao_Pos[4] = {x=1748, z=3141}
Quest_WaBao_Pos[5] = {x=1509, z=3184}
Quest_WaBao_Pos[6] = {x=1349, z=3041}
Quest_WaBao_Pos[7] = {x=1322, z=2990}
Quest_WaBao_Pos[8] = {x=1744, z=2635}
Quest_WaBao_Pos[9] = {x=1554, z=2149}
Quest_WaBao_Pos[10] = {x=1323, z=2160}
Quest_WaBao_Pos[11] = {x=1828, z=1479}
Quest_WaBao_Pos[12] = {x=1026, z=1084}
Quest_WaBao_Pos[13] = {x=1092, z=1008}
Quest_WaBao_Pos[14] = {x=2489, z=948}
Quest_WaBao_Pos[15] = {x=2713, z=775}
Quest_WaBao_Pos[16] = {x=2637, z=996}
Quest_WaBao_Pos[17] = {x=2272, z=1173}
Quest_WaBao_Pos[18] = {x=3052, z=1472}
Quest_WaBao_Pos[19] = {x=2970, z=1413}
Quest_WaBao_Pos[20] = {x=2411, z=1930}

--[[Quest_WaBao_Pos[1] = {x=1297, z=3400}
Quest_WaBao_Pos[2] = {x=1539, z=3744}
Quest_WaBao_Pos[3] = {x=1750, z=3452}
Quest_WaBao_Pos[4] = {x=2284, z=3501}
Quest_WaBao_Pos[5] = {x=2927, z=3407}
Quest_WaBao_Pos[6] = {x=3277, z=3126}
Quest_WaBao_Pos[7] = {x=3510, z=3014}
Quest_WaBao_Pos[11] = {x=878, z=904}
Quest_WaBao_Pos[12] = {x=533, z=826}
Quest_WaBao_Pos[13] = {x=603, z=1404}
Quest_WaBao_Pos[14] = {x=1458, z=2077}
Quest_WaBao_Pos[15] = {x=1965, z=2329}
Quest_WaBao_Pos[16] = {x=1847, z=1865}
Quest_WaBao_Pos[17] = {x=2268, z=1596}
Quest_WaBao_Pos[21] = {x=1097, z=2086}
Quest_WaBao_Pos[22] = {x=1580, z=1987}
Quest_WaBao_Pos[23] = {x=1966, z=1918}
Quest_WaBao_Pos[24] = {x=2176, z=1679}
Quest_WaBao_Pos[25] = {x=2141, z=1379}
Quest_WaBao_Pos[26] = {x=2162, z=1107}
Quest_WaBao_Pos[27] = {x=1782, z=711}
Quest_WaBao_Pos[31] = {x=995, z=1590}
Quest_WaBao_Pos[32] = {x=1154, z=1652}
Quest_WaBao_Pos[33] = {x=1273, z=2024}
Quest_WaBao_Pos[34] = {x=1710, z=2028}
Quest_WaBao_Pos[35] = {x=1882, z=2009}
Quest_WaBao_Pos[36] = {x=2341, z=1758}
Quest_WaBao_Pos[37] = {x=2339, z=1320}
Quest_WaBao_Pos[41] = {x=914, z=1001}
Quest_WaBao_Pos[42] = {x=1360, z=1322}
Quest_WaBao_Pos[43] = {x=1471, z=1926}
Quest_WaBao_Pos[44] = {x=2315, z=2075}
Quest_WaBao_Pos[45] = {x=2493, z=1405}
Quest_WaBao_Pos[46] = {x=2142, z=967}
Quest_WaBao_Pos[47] = {x=1904, z=685}
Quest_WaBao_Pos[51] = {x=1558, z=2094}
Quest_WaBao_Pos[52] = {x=1160, z=2150}
Quest_WaBao_Pos[53] = {x=896, z=1599}
Quest_WaBao_Pos[54] = {x=1560, z=1333}
Quest_WaBao_Pos[55] = {x=1861, z=1443}
Quest_WaBao_Pos[56] = {x=2265, z=1350}
Quest_WaBao_Pos[57] = {x=1333, z=586}
Quest_WaBao_Pos[61] = {x=1000, z=1000}--------
Quest_WaBao_Pos[62] = {x=1635, z=1759}--------
Quest_WaBao_Pos[63] = {x=988, z=2761}--------
Quest_WaBao_Pos[64] = {x=899, z=3221}--------
Quest_WaBao_Pos[65] = {x=2517, z=3257}--------
Quest_WaBao_Pos[66] = {x=2354, z=2285}--------
Quest_WaBao_Pos[67] = {x=2364, z=1455}--------]]




--接取任务
function x20033_OnQuestInit(MapID, InstanceID, QuestID, OwnerID, NPCID)

	--随机得到表中的一个索引
	local Index = 0
	local rolelevel = role.GetRoleLevel(MapID, InstanceID, OwnerID)

	if 	rolelevel>=100  then
	    Index = math.random(43,49)
	elseif rolelevel>=90 then
		Index = math.random(36,42)
	elseif rolelevel>=80 then
		Index = math.random(29,35)
	elseif rolelevel>=70 then
		Index = math.random(22,28)
	elseif rolelevel>=60 then
		Index = math.random(15,21)
	elseif rolelevel>=50 then
		Index = math.random(8 ,14)
	elseif rolelevel>=40 then
		Index = math.random(1 ,7)
	end

	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Index"], Index)

	--给予玩家密令道具
	role.AddRoleItem(MapID, InstanceID, OwnerID, 1350101, 1, -1, 8, 102)

	--扣除玩家3000游戏币
	role.DecRoleSilver(MapID, InstanceID, OwnerID, 3000, 101)

	--初始化任务的动态数据
	role.QuestInit(OwnerID, QuestID, GetRandQuestTable(Quest_WaBao, Index))

	--同步客户端总任务环数和任务说明
	local LoopNum = role.GetRoleScriptData(OwnerID, 1, RoleDataType["WaBao"])
	local MsgID = msg.BeginMsgEvent()
	msg.AddMsgEvent(MsgID, 11, QuestID)
	msg.AddMsgEvent(MsgID, 10, LoopNum)
	msg.AddMsgEvent(MsgID, 1, Quest_WaBao[Index].MsgID)
	msg.DispatchRoleMsgEvent(OwnerID, MsgID)
end

--完成任务
function x20033_OnComplete(MapID, InstanceID, QuestID, OwnerID, NPCID)

	--local exp_award = {}
	--exp_award[4] = 2480
	--exp_award[5] = 3450
	--exp_award[6] = 4550
	--exp_award[7] = 6200
	--exp_award[8] = 7930
	--exp_award[9] = 10050
	--exp_award[10]= 11680


-- 狭义门经验奖励
	local exp_award = {}
	exp_award[4]=5650
	exp_award[5]=9216
	exp_award[6]=13196
	exp_award[7]=17576
	exp_award[8]=22356
	exp_award[9]=27536
	exp_award[10]=30276

	local k = math.floor(role.GetRoleLevel(MapID, InstanceID, OwnerID)/10)
	if k>10 then
		k = 10
	end

	--得到当前任务总环数
	local LoopNum = role.GetRoleScriptData(OwnerID, 1, RoleDataType["WaBao"])
	local TotalNum = role.GetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Total"])
	--计算环数
	local LoopNum_Ring = LoopNum % 10
	if  LoopNum_Ring == 0 then
		LoopNum_Ring = 10
	end
	--计算轮数
	local LoopNum_Round = (LoopNum - LoopNum_Ring) /10 + 1
	--计算经验及金钱奖励
	local Double = 0
		if  LoopNum_Round <= 2 then
		Double = 1
		else
		Double = 0.5
		end
	local Exp = exp_award[k]*Double
	local Silver = (LoopNum_Round + LoopNum_Ring*0.1)*3000*Double
	local rolelevel = role.GetRoleLevel(MapID, InstanceID, OwnerID)
	--local Index = math.random(1,100)
		if rolelevel>=40 and rolelevel<=49 then
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
			--if Index >=1 and Index<=5 then
			--奖励玩家物品
			--role.AddRoleItem(MapID, InstanceID, OwnerID, 1350002, 1, -1, 8, 102)
			--end
		elseif rolelevel>=50 and rolelevel<=59 then
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
			--if Index >=6 and Index<=9 then
			--奖励玩家物品
			--role.AddRoleItem(MapID, InstanceID, OwnerID, 1350002, 1, -1, 8, 102)
			--end
		elseif rolelevel>=60 and rolelevel<=69 then
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
			--if Index >=10 and Index<=12 then
			--奖励玩家物品
			--role.AddRoleItem(MapID, InstanceID, OwnerID, 1350002, 1, -1, 8, 102)
			--end
		elseif rolelevel>=70 and rolelevel<=79 then
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
			--if Index >=13 and Index<=14 then
			--奖励玩家物品
			--role.AddRoleItem(MapID, InstanceID, OwnerID, 1350002, 1, -1, 8, 102)
			--end
		elseif rolelevel>=80 and rolelevel<=89 then
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
			--if Index ==15 then
			--奖励玩家物品
			--role.AddRoleItem(MapID, InstanceID, OwnerID, 1350002, 1, -1, 8, 102)
			--end
		elseif rolelevel>=90 and rolelevel<=99 then
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
		else
			--奖励玩家经验
			role.AddRoleExp(MapID, InstanceID, OwnerID, Exp)
			--奖励玩家金钱
			role.AddRoleSilver(MapID, InstanceID, OwnerID, Silver, 101)
		end
	--总任务环数加一
	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao"], LoopNum+1)
	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Total"], TotalNum+1)
	--设置当前挖宝任务Index为0(GT_INVALID)
	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Index"], 0)
	--增加进阶实力值
	Increase_shili(MapID, InstanceID, OwnerID, 0, 1, "jinjieshili_Q")
	if LoopNum == 100 then
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 71, 416)
		--msg.AddMsgEvent(MsgID, 10, LoopNum)
		msg.DispatchRoleMsgEvent(OwnerID, MsgID)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 1, 416)
		--msg.AddMsgEvent(MsgID, 10, LoopNum)
		msg.DispatchRoleMsgEvent(OwnerID, MsgID)
	else
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 71, 415)
		--msg.AddMsgEvent(MsgID, 10, LoopNum)
		msg.DispatchRoleMsgEvent(OwnerID, MsgID)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 1, 415)
		--msg.AddMsgEvent(MsgID, 10, LoopNum)
		msg.DispatchRoleMsgEvent(OwnerID, MsgID)
	end
end

--放弃任务
function x20033_OnCancel(MapID, InstanceID, QuestID, OwnerID)

	local LoopNum = role.GetRoleScriptData(OwnerID, 1, RoleDataType["WaBao"])
	local TotalNum = role.GetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Total"])
	local k = LoopNum % 10
	if k == 0 then
		k=10
	end
	--总任务环数加一，当前环数置为1
	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao"], LoopNum-k+1)
	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Total"], TotalNum+1)
	--设置当前挖宝任务Index为0(GT_INVALID)
	role.SetRoleScriptData(OwnerID, 1, RoleDataType["WaBao_Index"], 0)
end

function x20033_OnCheckAccept(MapID, InstanceID, QuestID, RoleID, NPCID)

	--判断金钱是否足够
	local rolesilver = role.GetRoleSilver(MapID, InstanceID, RoleID)
	if(rolesilver < 3000) then
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 26, 146)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
		return 0
	end

	--判断背包空闲空间是否足够
	local FreeSize = role.GetBagFreeSize(RoleID)
	if(FreeSize < 1) then
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 26, 141)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
		return 0
	end

	--判断本日任务接取次数是否已满
	--得到当前任务总任务环数
	local LoopNum = role.GetRoleScriptData(RoleID, 1, RoleDataType["WaBao"])
	local TotalNum = role.GetRoleScriptData(RoleID, 1, RoleDataType["WaBao_Total"])
	local UpdateTime = role.GetRoleScriptData(RoleID, 1, RoleDataType["WaBao_Update"])

	--总环数为0时，设置总环数为第一环
	if 0 == LoopNum then
		LoopNum = 1
		role.SetRoleScriptData(RoleID, 1, RoleDataType["WaBao"], LoopNum)
	end
	if 0 == TotalNum then
		TotalNum = 1
		role.SetRoleScriptData(RoleID, 1, RoleDataType["WaBao_Total"], TotalNum)
	end

	--检测任务上次更新日期，若与当前日期不一致，则重置总环数及更新日期
	local a = os.time()
	local CurTime = tonumber(os.date("%j"))
	if CurTime~=UpdateTime then
		TotalNum = 1
		role.SetRoleScriptData(RoleID, 1, RoleDataType["WaBao_Total"], TotalNum)
		LoopNum = 1
		role.SetRoleScriptData(RoleID, 1, RoleDataType["WaBao"], LoopNum)
		role.SetRoleScriptData(RoleID, 1, RoleDataType["WaBao_Update"], CurTime)
	end
	--若本日已接取30次，则无法再接取
	if TotalNum > 100 then
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 71, 147)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
		return 0
	end

	return 1
end

function x20033_OnCheckComplete(MapID, InstanceID, QuestID, RoleID, NPCID)
	--判断背包空闲空间是否足够
	local FreeSize = role.GetBagFreeSize(RoleID)
	if(FreeSize < 1) then
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 71, 142)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
		return 0
	end

	return 1
end


aux.RegisterQuestEvent(20033, 1, "x20033_OnComplete")
aux.RegisterQuestEvent(20033, 7, "x20033_OnQuestInit")
aux.RegisterQuestEvent(20033, 2, "x20033_OnCancel")
aux.RegisterQuestEvent(20033, 4, "x20033_OnCheckAccept")
aux.RegisterQuestEvent(20033, 5, "x20033_OnCheckComplete")

function I1350101_CanUse(MapID, InstanceID, TypeID, TargetID)
	local bRet, bIgnore = 0, false

	--判断玩家是否接有挖宝任务
	local Index = role.GetRoleScriptData(TargetID, 1, RoleDataType["WaBao_Index"])
	if Index == 0 then
		bRet = 42
	end

	--判断使用地点限制
	--local --mapcrc = {}
	--mapcrc[1] = 3017298127
	--mapcrc[2] = 3017298383
	--mapcrc = 3017299663
	--mapcrc[4] = 3017299919
	--mapcrc[5] = 3017299151
	--mapcrc[6] = 1146339967
	--mapcrc[7] = 3017299407
	local x, y ,z = unit.GetPosition(MapID, InstanceID, TargetID)
	--local Pos_Index = math.floor((Index-1)/7)
	local Pos_Index = Index % 15
	local curmapcrc = 3017299663 --mapcrc[Pos_Index+1]
	local Pos_Index = Pos_Index + Quest_WaBao[Index].TargetID1 - 1351001

	if MapID ~= curmapcrc then
		bRet = 36
	end
	if x>Quest_WaBao_Pos[Pos_Index].x + 16 then
		bRet = 36
	end
	if x<Quest_WaBao_Pos[Pos_Index].x - 16 then
		bRet = 36
	end
	if z>Quest_WaBao_Pos[Pos_Index].z + 16 then
		bRet = 36
	end
	if z<Quest_WaBao_Pos[Pos_Index].z - 16 then
		bRet = 36
	end

	if bRet==36 then
		local MsgID = msg.BeginMsgEvent()
		--msg.AddMsgEvent(MsgID, 13, 0)
		msg.AddMsgEvent(MsgID, 71, 65)
		msg.AddMsgEvent(MsgID, 6, curmapcrc)
		msg.AddMsgEvent(MsgID, 9, Quest_WaBao_Pos[Pos_Index].x)
		msg.AddMsgEvent(MsgID, 9, Quest_WaBao_Pos[Pos_Index].z)
		msg.DispatchRoleMsgEvent(TargetID, MsgID)
	end

	return bRet, bIgnore
end



function I1350101_Wabao(MapID, InstanceID, TypeID, TargetID)
	local rolelevel = role.GetRoleLevel(MapID, InstanceID, TargetID)
	if rolelevel > 100 then
	    rolelevel = 100
	end
	local Index = role.GetRoleScriptData(TargetID, 1, RoleDataType["WaBao_Index"])
	local x, y ,z = unit.GetPosition(MapID, InstanceID, TargetID)
	local itemid = Quest_WaBao[Index].TargetID1

	local k = math.floor(rolelevel/10)-4
	local monsterid = 1511000 + k * 10 + itemid - 1351000
	map.MapCreateCreature(MapID, InstanceID, monsterid, x+2, y, z+2)

end

aux.RegisterItemEvent(1350101, 0, "I1350101_CanUse")
aux.RegisterItemEvent(1350101, 1, "I1350101_Wabao")
















